#! /bin/bash

set -e
set -x

## change user
git config user.email "giovanni.bussi+plumedbot@gmail.com"
git config user.name "plumedbot"

# clone plumed repo
git clone https://github.com/plumed/plumed2.git

# go to plumed repo
cd plumed2

# add plumedbot/plumed2 fork
set +x # this is not to show the GIT_TOKEN on Travis log
git remote add plumedbot https://plumedbot:$GIT_TOKEN@github.com/plumedbot/plumed2.git
cat > $HOME/.config/hub << EOF
github.com:
- user: plumedbot
  oauth_token: $GIT_TOKEN
  protocol: https
EOF
set -x

# loop over arguments
for branch
do

git checkout $branch
hash=$( git log -1 --format="%h")
newbranch=$branch-$hash
git checkout -b $newbranch

changes=false

make -C src/lib/ dirslinks

cd src && ./header.sh && cd -

cat > commit-$newbranch  << EOF
Plumedbot commit: headers

This commit contains changes automatically generated by plumedbot on Travis-ci.
EOF

if git commit -F commit-$newbranch
then
  changes=true
fi

if [ "$changes" = true ] ; then

echo "Pushing to plumedbot"

# -q and 2> is not to show the GIT_TOKEN on Travis log
git push -q -f plumedbot $newbranch 2> /dev/null 

cat > pull-request-$newbranch << EOF
Plumedbot pull request

This pull request contains changes automatically generated by plumedbot on Travis-ci.
Please review them and, if correct, merge them to branch $branch.
EOF

echo hub pull-request -F pull-request-$newbranch -h plumedbot/plumed2:$newbranch -b plumed/plumed2:$branch

fi


done
